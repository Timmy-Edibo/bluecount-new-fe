(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{850:(e,t,n)=>{Promise.resolve().then(n.t.bind(n,3673,23)),Promise.resolve().then(n.bind(n,4442)),Promise.resolve().then(n.bind(n,8568)),Promise.resolve().then(n.bind(n,5380)),Promise.resolve().then(n.bind(n,8380))},3673:()=>{},4442:(e,t,n)=>{"use strict";n.d(t,{InstallPWA:()=>a});var i=n(5155),s=n(2115);function a(e){let{variant:t="sidebar"}=e,[n,a]=(0,s.useState)(null),[o,l]=(0,s.useState)(!1),[d,r]=(0,s.useState)(!1),[u,c]=(0,s.useState)(!1);(0,s.useEffect)(()=>{if("1"===sessionStorage.getItem("pwa-install-dismissed")&&r(!0),window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)return void l(!0);let e=window.navigator.userAgent;c(/iPad|iPhone|iPod/.test(e)&&!window.MSStream);let t=e=>{e.preventDefault(),a(e)};return window.addEventListener("beforeinstallprompt",t),()=>window.removeEventListener("beforeinstallprompt",t)},[]);let _=async()=>{if(!n)return;await n.prompt();let{outcome:e}=await n.userChoice;"accepted"===e&&a(null)},p=()=>{r(!0),"undefined"!=typeof sessionStorage&&sessionStorage.setItem("pwa-install-dismissed","1")};if(o||d||!n&&!u)return null;let v="banner"===t;return(0,i.jsx)("div",{className:v?"fixed bottom-0 left-0 right-0 z-50 flex items-center justify-between gap-4 border-t border-slate-600 bg-slate-800 px-4 py-3 shadow-lg":"border-t border-slate-700 p-3 space-y-2",children:n?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("p",{className:v?"text-slate-300 text-sm":"text-slate-400 text-xs",children:"Install Bluecounts for offline use"}),(0,i.jsxs)("div",{className:"flex gap-2 shrink-0",children:[(0,i.jsx)("button",{type:"button",onClick:_,className:"rounded-lg bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-500",children:"Install app"}),(0,i.jsx)("button",{type:"button",onClick:p,className:"rounded-lg px-3 py-2 text-sm text-slate-500 hover:text-slate-300","aria-label":"Dismiss",children:"Not now"})]})]}):u?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("p",{className:v?"text-slate-300 text-sm":"text-slate-400 text-xs",children:["Install: tap Share ",(0,i.jsx)("span",{"aria-hidden":!0,children:"âŽ‹"}),' then "Add to Home Screen"']}),(0,i.jsx)("button",{type:"button",onClick:p,className:"shrink-0 text-slate-500 hover:text-slate-300 text-sm",children:"Dismiss"})]}):null})}},5380:(e,t,n)=>{"use strict";n.d(t,{A:()=>c,AuthProvider:()=>u,c:()=>_});var i=n(5155),s=n(2115);let a=n(5704).env.NEXT_PUBLIC_API_URL||"http://localhost:3001",o="bluecounts_auth",l={user:null,tenant:null,role:"",outletId:null,token:null},d=(0,s.createContext)(null);function r(e){e.token&&e.tenant?localStorage.setItem(o,JSON.stringify(e)):localStorage.removeItem(o)}function u(e){let{children:t}=e,[n,u]=(0,s.useState)(l);(0,s.useEffect)(()=>{u(function(){try{var e,t,n,i,s;let a=localStorage.getItem(o);if(!a)return l;let d=JSON.parse(a);if((null==d?void 0:d.token)&&(null==d||null==(e=d.tenant)?void 0:e.id))return{user:null!=(t=d.user)?t:null,tenant:null!=(n=d.tenant)?n:null,role:null!=(i=d.role)?i:"",outletId:null!=(s=d.outletId)?s:null,token:d.token}}catch(e){}return l}())},[]);let c=(0,s.useCallback)(e=>{u(e),r(e)},[]),_=(0,s.useCallback)(async(e,t)=>{var n;let i=await fetch("".concat(a,"/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!i.ok)throw Error((await i.json().catch(()=>({}))).error||"Login failed");let s=await i.json();c({user:s.user,tenant:s.tenant,role:s.role,outletId:null!=(n=s.outletId)?n:null,token:s.token})},[c]),p=(0,s.useCallback)(async(e,t,n)=>{let i=await fetch("".concat(a,"/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t,businessName:n})});if(!i.ok)throw Error((await i.json().catch(()=>({}))).error||"Registration failed");let s=await i.json();c({user:s.user,tenant:s.tenant,role:s.role,outletId:null,token:s.token})},[c]),v=(0,s.useCallback)(()=>{c(l)},[c]),h=(0,s.useCallback)(e=>{u(t=>{let n={...t,outletId:e};return r(n),n})},[]);return(0,i.jsx)(d.Provider,{value:{...n,login:_,register:p,logout:v,setOutletId:h,setAuth:c},children:t})}function c(){let e=(0,s.useContext)(d);if(!e)throw Error("useAuth must be used within AuthProvider");return e}function _(){try{var e;let t=localStorage.getItem(o);if(!t)return null;let n=JSON.parse(t);return null!=(e=null==n?void 0:n.token)?e:null}catch(e){return null}}},7138:(e,t,n)=>{"use strict";n.d(t,{db:()=>a});var i=n(3278);class s extends i.Ay{constructor(){super("BluecountsDB"),this.version(1).stores({products:"id, tenant_id, outlet_id, [tenant_id+outlet_id], [tenant_id+sku], version_id",inventory:"id, tenant_id, outlet_id, product_id, [tenant_id+outlet_id+product_id], version_id",sales:"id, tenant_id, outlet_id, device_id, [tenant_id+device_id+device_transaction_id], version_id, created_at",sale_items:"id, sale_id, tenant_id, outlet_id, product_id",sync_queue:"id, timestamp, status",sync_meta:"key"}),this.version(2).stores({products:"id, tenant_id, outlet_id, [tenant_id+outlet_id], [tenant_id+sku], version_id",inventory:"id, tenant_id, outlet_id, product_id, [tenant_id+outlet_id+product_id], version_id",sales:"id, tenant_id, outlet_id, device_id, session_id, [tenant_id+device_id+device_transaction_id], version_id, created_at",sale_items:"id, sale_id, tenant_id, outlet_id, product_id",pos_sessions:"id, tenant_id, outlet_id, user_id, [outlet_id+status], version_id, opened_at",sync_queue:"id, timestamp, status",sync_meta:"key"}),this.version(3).stores({products:"id, tenant_id, [tenant_id+sku], version_id",inventory:"id, tenant_id, outlet_id, product_id, [tenant_id+outlet_id+product_id], version_id",sales:"id, tenant_id, outlet_id, device_id, session_id, [tenant_id+device_id+device_transaction_id], version_id, created_at",sale_items:"id, sale_id, tenant_id, outlet_id, product_id",pos_sessions:"id, tenant_id, outlet_id, user_id, [outlet_id+status], version_id, opened_at",sync_queue:"id, timestamp, status",sync_meta:"key"})}}let a=new s},8380:(e,t,n)=>{"use strict";n.d(t,{SessionProvider:()=>r,w:()=>u});var i=n(5155),s=n(2115),a=n(7138),o=n(5380);let l=n(5704).env.NEXT_PUBLIC_API_URL||"http://localhost:3001",d=(0,s.createContext)(null);function r(e){var t,n,r,u,c,_;let{children:p}=e,v=(0,o.A)(),[h,b]=(0,s.useState)(null),[m,f]=(0,s.useState)(!0),g=null!=(r=null==(t=v.tenant)?void 0:t.id)?r:"",w=null!=(u=v.outletId)?u:"",y=null!=(c=null==(n=v.user)?void 0:n.id)?c:"",S=null!=(_=localStorage.getItem("bluecounts_device_id"))?_:"",x=(0,s.useCallback)(async()=>{if(!g||!w){b(null),f(!1);return}f(!0);try{let t=(0,o.c)();if(t){let n=await fetch("".concat(l,"/sessions?outlet_id=").concat(encodeURIComponent(w),"&status=open"),{headers:{Authorization:"Bearer ".concat(t)}});if(n.ok){var e;let t=null==(e=(await n.json()).sessions)?void 0:e.find(e=>"open"===e.status);if(t){b({id:t.id,openingBalance:t.opening_balance,outletId:t.outlet_id}),f(!1);return}}}let n=await a.db.pos_sessions.where("[outlet_id+status]").equals([w,"open"]).first();n?b({id:n.id,openingBalance:n.opening_balance,outletId:n.outlet_id}):b(null)}catch(t){let e=await a.db.pos_sessions.where("[outlet_id+status]").equals([w,"open"]).first();e?b({id:e.id,openingBalance:e.opening_balance,outletId:e.outlet_id}):b(null)}finally{f(!1)}},[g,w]);(0,s.useEffect)(()=>{x()},[x]);let k=(0,s.useCallback)(async(e,t,n)=>{let i=n||S,s=(0,o.c)(),d=crypto.randomUUID(),r=new Date().toISOString();if(s)try{let n=await fetch("".concat(l,"/sessions/open"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)},body:JSON.stringify({outlet_id:e,device_id:i||void 0,opening_balance:t})});if(n.ok){var u,c,_;let s=await n.json(),o=s.session_id;b({id:o,openingBalance:null!=(u=s.opening_balance)?u:t,outletId:e}),await a.db.pos_sessions.put({id:o,tenant_id:g,outlet_id:e,user_id:y,device_id:i||null,opening_balance:null!=(c=s.opening_balance)?c:t,status:"open",opened_at:new Date().toISOString(),version_id:null!=(_=s.version_id)?_:0});return}}catch(e){}await a.db.sync_queue.add({id:crypto.randomUUID(),action_type:"OPEN_SESSION",payload:{id:d,outlet_id:e,device_id:i||void 0,opening_balance:t,opened_at:r,user_id:y},timestamp:Date.now(),status:"pending"}),await a.db.pos_sessions.put({id:d,tenant_id:g,outlet_id:e,user_id:y,device_id:i||null,opening_balance:t,status:"open",opened_at:r,version_id:0}),b({id:d,openingBalance:t,outletId:e})},[g,y,S]),I=(0,s.useCallback)(async(e,t)=>{var n,i,s,d;let r=(0,o.c)(),u=new Date().toISOString();if(r)try{let o=await fetch("".concat(l,"/sessions/").concat(e,"/close"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)},body:JSON.stringify({closing_balance:t})});if(o.ok){let l=await o.json();return await a.db.pos_sessions.update(e,{closing_balance:t,expected_balance:null!=(n=l.expected_balance)?n:null,status:"closed",closed_at:u,version_id:null!=(i=l.version_id)?i:0}),b(null),{variance:null!=(s=l.variance)?s:0}}}catch(e){}await a.db.sync_queue.add({id:crypto.randomUUID(),action_type:"CLOSE_SESSION",payload:{session_id:e,closing_balance:t,closed_at:u},timestamp:Date.now(),status:"pending"});let c=await a.db.pos_sessions.get(e),_=(await a.db.sales.where("session_id").equals(e).toArray()).reduce((e,t)=>e+t.total_amount,0),p=(null!=(d=null==c?void 0:c.opening_balance)?d:0)+_;return await a.db.pos_sessions.update(e,{closing_balance:t,expected_balance:p,status:"closed",closed_at:u}),b(null),{variance:t-p}},[]);return(0,i.jsx)(d.Provider,{value:{currentSession:h,loading:m,openSession:k,closeSession:I,refreshSession:x},children:p})}function u(){let e=(0,s.useContext)(d);if(!e)throw Error("useSession must be used within SessionProvider");return e}},8568:(e,t,n)=>{"use strict";n.d(t,{PWARegister:()=>s});var i=n(2115);function s(){return(0,i.useEffect)(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js",{scope:"/",updateViaCache:"none"}).then(e=>{e.addEventListener("updatefound",()=>{let t=e.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller})})}).catch(()=>{})},[]),null}}},e=>{e.O(0,[978,278,441,255,358],()=>e(e.s=850)),_N_E=e.O()}]);
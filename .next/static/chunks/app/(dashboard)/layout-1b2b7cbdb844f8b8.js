(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[305],{63:(e,t,s)=>{"use strict";var l=s(7260);s.o(l,"usePathname")&&s.d(t,{usePathname:function(){return l.usePathname}}),s.o(l,"useRouter")&&s.d(t,{useRouter:function(){return l.useRouter}}),s.o(l,"useSearchParams")&&s.d(t,{useSearchParams:function(){return l.useSearchParams}})},6962:(e,t,s)=>{Promise.resolve().then(s.bind(s,8937))},8380:(e,t,s)=>{"use strict";s.d(t,{SessionProvider:()=>c,w:()=>d});var l=s(5155),n=s(2115),a=s(7138),o=s(5380);let i=s(5704).env.NEXT_PUBLIC_API_URL||"http://localhost:3001",r=(0,n.createContext)(null);function c(e){var t,s,c,d,u,x;let{children:m}=e,p=(0,o.A)(),[b,h]=(0,n.useState)(null),[f,g]=(0,n.useState)(!0),_=null!=(c=null==(t=p.tenant)?void 0:t.id)?c:"",v=null!=(d=p.outletId)?d:"",y=null!=(u=null==(s=p.user)?void 0:s.id)?u:"",j=null!=(x=localStorage.getItem("bluecounts_device_id"))?x:"",N=(0,n.useCallback)(async()=>{if(!_||!v){h(null),g(!1);return}g(!0);try{let t=(0,o.c)();if(t){let s=await fetch("".concat(i,"/sessions?outlet_id=").concat(encodeURIComponent(v),"&status=open"),{headers:{Authorization:"Bearer ".concat(t)}});if(s.ok){var e;let t=null==(e=(await s.json()).sessions)?void 0:e.find(e=>"open"===e.status);if(t){h({id:t.id,openingBalance:t.opening_balance,outletId:t.outlet_id}),g(!1);return}}}let s=await a.db.pos_sessions.where("[outlet_id+status]").equals([v,"open"]).first();s?h({id:s.id,openingBalance:s.opening_balance,outletId:s.outlet_id}):h(null)}catch(t){let e=await a.db.pos_sessions.where("[outlet_id+status]").equals([v,"open"]).first();e?h({id:e.id,openingBalance:e.opening_balance,outletId:e.outlet_id}):h(null)}finally{g(!1)}},[_,v]);(0,n.useEffect)(()=>{N()},[N]);let S=(0,n.useCallback)(async(e,t,s)=>{let l=s||j,n=(0,o.c)(),r=crypto.randomUUID(),c=new Date().toISOString();if(n)try{let s=await fetch("".concat(i,"/sessions/open"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n)},body:JSON.stringify({outlet_id:e,device_id:l||void 0,opening_balance:t})});if(s.ok){var d,u,x;let n=await s.json(),o=n.session_id;h({id:o,openingBalance:null!=(d=n.opening_balance)?d:t,outletId:e}),await a.db.pos_sessions.put({id:o,tenant_id:_,outlet_id:e,user_id:y,device_id:l||null,opening_balance:null!=(u=n.opening_balance)?u:t,status:"open",opened_at:new Date().toISOString(),version_id:null!=(x=n.version_id)?x:0});return}}catch(e){}await a.db.sync_queue.add({id:crypto.randomUUID(),action_type:"OPEN_SESSION",payload:{id:r,outlet_id:e,device_id:l||void 0,opening_balance:t,opened_at:c,user_id:y},timestamp:Date.now(),status:"pending"}),await a.db.pos_sessions.put({id:r,tenant_id:_,outlet_id:e,user_id:y,device_id:l||null,opening_balance:t,status:"open",opened_at:c,version_id:0}),h({id:r,openingBalance:t,outletId:e})},[_,y,j]),w=(0,n.useCallback)(async(e,t)=>{var s,l,n,r;let c=(0,o.c)(),d=new Date().toISOString();if(c)try{let o=await fetch("".concat(i,"/sessions/").concat(e,"/close"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(c)},body:JSON.stringify({closing_balance:t})});if(o.ok){let i=await o.json();return await a.db.pos_sessions.update(e,{closing_balance:t,expected_balance:null!=(s=i.expected_balance)?s:null,status:"closed",closed_at:d,version_id:null!=(l=i.version_id)?l:0}),h(null),{variance:null!=(n=i.variance)?n:0}}}catch(e){}await a.db.sync_queue.add({id:crypto.randomUUID(),action_type:"CLOSE_SESSION",payload:{session_id:e,closing_balance:t,closed_at:d},timestamp:Date.now(),status:"pending"});let u=await a.db.pos_sessions.get(e),x=(await a.db.sales.where("session_id").equals(e).toArray()).reduce((e,t)=>e+t.total_amount,0),m=(null!=(r=null==u?void 0:u.opening_balance)?r:0)+x;return await a.db.pos_sessions.update(e,{closing_balance:t,expected_balance:m,status:"closed",closed_at:d}),h(null),{variance:t-m}},[]);return(0,l.jsx)(r.Provider,{value:{currentSession:b,loading:f,openSession:S,closeSession:w,refreshSession:N},children:m})}function d(){let e=(0,n.useContext)(r);if(!e)throw Error("useSession must be used within SessionProvider");return e}},8937:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var l=s(5155),n=s(2115),a=s(2619),o=s.n(a),i=s(63),r=s(5380),c=s(8380),d=s(9058);let u=s(5704).env.NEXT_PUBLIC_API_URL||"http://localhost:3001",x="bluecounts_device_id";function m(e){var t,s,a,m;let p,{onCloseSession:b}=e,h=(0,i.usePathname)(),f=(0,r.A)(),g=(0,c.w)(),[_,v]=(0,n.useState)([]),y=null!=(s=null==(t=f.tenant)?void 0:t.id)?s:"",j=null!=(a=f.outletId)?a:"",N=((p=localStorage.getItem(x))||(p=crypto.randomUUID(),localStorage.setItem(x,p)),p),{isOnline:S,syncState:w,lastError:k,pendingCount:I,sync:C,simulateOffline:P,setSimulateOffline:O}=(0,d.a)({tenantId:y,outletId:j,deviceId:N,enabled:!!y&&!!j});(0,n.useEffect)(()=>{f.token&&f.tenant&&!(_.length>0)&&fetch("".concat(u,"/outlets"),{headers:{Authorization:"Bearer ".concat(f.token)}}).then(e=>e.ok?e.json():Promise.reject(Error("Failed to load outlets"))).then(e=>{var t;return v(null!=(t=e.outlets)?t:[])}).catch(()=>{})},[f.token,f.tenant,_.length]);let E=e=>"block w-full rounded-lg px-3 py-2 text-sm font-medium transition-colors ".concat(h===e?"bg-slate-600 text-slate-100":"text-slate-400 hover:bg-slate-700/50 hover:text-slate-200");return f.token?(0,l.jsxs)("aside",{className:"w-60 shrink-0 border-r border-slate-700 bg-slate-800/50 flex flex-col min-h-screen",children:[(0,l.jsxs)("div",{className:"p-4 border-b border-slate-700",children:[(0,l.jsx)(o(),{href:"/",className:"text-lg font-bold text-slate-100",children:"Bluecounts"}),f.tenant&&(0,l.jsx)("p",{className:"text-slate-500 text-xs mt-1 truncate",children:f.tenant.name})]}),(0,l.jsxs)("div",{className:"p-3 space-y-2 border-b border-slate-700",children:[f.user&&(0,l.jsx)("p",{className:"text-slate-400 text-sm truncate px-2",title:f.user.email,children:f.user.name||f.user.email}),_.length>0&&(0,l.jsxs)("select",{className:"w-full rounded-lg bg-slate-700 border border-slate-600 px-3 py-2 text-slate-200 text-sm",value:null!=(m=f.outletId)?m:"",onChange:e=>f.setOutletId(e.target.value||null),"aria-label":"Change outlet",children:[(0,l.jsx)("option",{value:"",children:"Select outlet"}),_.map(e=>(0,l.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,l.jsxs)("nav",{className:"p-3 flex-1 flex flex-col gap-0.5",children:[(0,l.jsx)(o(),{href:"/",className:E("/"),children:"POS"}),(0,l.jsx)(o(),{href:"/inventory",className:E("/inventory"),children:"Inventory"}),("OWNER"===f.role||"ADMIN"===f.role)&&(0,l.jsx)(o(),{href:"/staff",className:E("/staff"),children:"Staff"}),g.currentSession&&b&&(0,l.jsx)("button",{type:"button",onClick:b,className:"w-full text-left rounded-lg px-3 py-2 text-sm font-medium text-amber-400 hover:bg-amber-500/10 transition-colors",children:"Close Session"})]}),(0,l.jsxs)("div",{className:"p-3 border-t border-slate-700 space-y-2",children:[(0,l.jsxs)("span",{className:"inline-flex items-center gap-2 rounded-full px-2 py-1 text-xs font-medium ".concat(S?"bg-emerald-500/20 text-emerald-400":"bg-amber-500/20 text-amber-400"),children:[(0,l.jsx)("span",{className:"h-1.5 w-1.5 rounded-full ".concat(S?"bg-emerald-400":"bg-amber-400")}),S?"Online":"Offline"]}),I>0&&(0,l.jsxs)("span",{className:"block text-xs text-sky-400",children:[I," pending"]}),"idle"!==w&&(0,l.jsx)("span",{className:"block text-xs text-slate-400",children:"pulling"===w?"Pulling…":"pushing"===w?"Pushing…":"Syncing…"}),(0,l.jsx)("button",{type:"button",onClick:C,disabled:!S||"pulling"===w||"pushing"===w,className:"w-full rounded-lg bg-slate-600 py-2 text-sm font-medium text-white hover:bg-slate-500 disabled:opacity-50",children:"Sync now"}),!1,k&&(0,l.jsx)("p",{className:"text-xs text-red-400 truncate",title:k,children:"Sync error"}),(0,l.jsx)("button",{type:"button",onClick:()=>f.logout(),className:"w-full text-left rounded-lg px-3 py-2 text-sm text-slate-400 hover:bg-slate-700/50 hover:text-slate-200",children:"Sign out"})]})]}):(0,l.jsxs)("aside",{className:"w-56 shrink-0 border-r border-slate-700 bg-slate-800/50 flex flex-col",children:[(0,l.jsx)("div",{className:"p-4 border-b border-slate-700",children:(0,l.jsx)(o(),{href:"/",className:"text-lg font-bold text-slate-100",children:"Bluecounts"})}),(0,l.jsx)("nav",{className:"p-3 flex-1",children:(0,l.jsx)(o(),{href:"/login",className:"text-sky-400 hover:text-sky-300 text-sm font-medium",children:"Sign in"})})]})}var p=s(7138);function b(e){let{sessionId:t,openingBalance:s,onClose:a,onDismiss:o}=e,[i,r]=(0,n.useState)(""),[c,d]=(0,n.useState)(s),[u,x]=(0,n.useState)(null),[m,b]=(0,n.useState)(null),[h,f]=(0,n.useState)(!1),[g,_]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let e=!1;return p.db.sales.where("session_id").equals(t).toArray().then(t=>{e||d(s+t.reduce((e,t)=>e+t.total_amount,0))}),()=>{e=!0}},[t,s]);let v=async e=>{e.preventDefault(),b(null);let t=parseFloat(i);if(Number.isNaN(t)||t<0)return void b("Enter a valid closing balance (0 or more).");f(!0);try{let e=await a(t);(null==e?void 0:e.variance)!=null&&x(e.variance),_(!0)}catch(e){b(e instanceof Error?e.message:"Failed to close session")}finally{f(!1)}};return g?(0,l.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:(0,l.jsxs)("div",{className:"rounded-xl bg-slate-800 border border-slate-700 p-6 max-w-sm w-full",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-slate-200 mb-2",children:"Session closed"}),null!=u&&(0,l.jsxs)("p",{className:"text-sm mb-4 ".concat(0===u?"text-slate-400":"text-amber-400"),children:["Variance: ",u>=0?"+":"",u.toFixed(2)]}),(0,l.jsx)("button",{type:"button",onClick:o,className:"w-full rounded-lg bg-slate-600 px-4 py-2 text-sm font-medium text-white hover:bg-slate-500",children:"Done"})]})}):(0,l.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:(0,l.jsxs)("div",{className:"rounded-xl bg-slate-800 border border-slate-700 p-6 max-w-sm w-full",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold text-slate-200 mb-4",children:"Close Session"}),(0,l.jsxs)("p",{className:"text-slate-400 text-sm mb-2",children:["Opening balance: $",s.toFixed(2)]}),(0,l.jsxs)("p",{className:"text-slate-400 text-sm mb-4",children:["Expected (opening + sales): $",c.toFixed(2)]}),(0,l.jsxs)("form",{onSubmit:v,className:"space-y-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{htmlFor:"closing_balance",className:"block text-sm font-medium text-slate-300 mb-1",children:"Actual cash count *"}),(0,l.jsx)("input",{id:"closing_balance",type:"number",step:"0.01",min:"0",value:i,onChange:e=>r(e.target.value),className:"w-full rounded-lg bg-slate-700 border border-slate-600 px-3 py-2 text-slate-200",placeholder:"0.00",required:!0})]}),m&&(0,l.jsx)("p",{className:"text-sm text-red-400",children:m}),(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:o,className:"flex-1 rounded-lg bg-slate-600 px-4 py-2 text-sm font-medium text-white hover:bg-slate-500",children:"Cancel"}),(0,l.jsx)("button",{type:"submit",disabled:h,className:"flex-1 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-500 disabled:opacity-50",children:h?"Closing…":"Close Session"})]})]})]})})}function h(e){let{children:t}=e,[s,a]=(0,n.useState)(!1),o=(0,c.w)();return(0,l.jsxs)("div",{className:"flex min-h-screen",children:[(0,l.jsx)(m,{onCloseSession:()=>a(!0)}),(0,l.jsx)("main",{className:"flex-1 min-w-0 p-4 md:p-6",children:t}),s&&o.currentSession&&(0,l.jsx)(b,{sessionId:o.currentSession.id,openingBalance:o.currentSession.openingBalance,onClose:e=>o.closeSession(o.currentSession.id,e),onDismiss:()=>a(!1)})]})}}},e=>{e.O(0,[619,278,58,441,255,358],()=>e(e.s=6962)),_N_E=e.O()}]);
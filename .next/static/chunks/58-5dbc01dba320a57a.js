"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[58],{5380:(e,t,n)=>{n.d(t,{A:()=>_,AuthProvider:()=>r,c:()=>c});var i=n(5155),a=n(2115);let d=n(5704).env.NEXT_PUBLIC_API_URL||"http://localhost:3001",l="bluecounts_auth",o={user:null,tenant:null,role:"",outletId:null,token:null},s=(0,a.createContext)(null);function u(e){e.token&&e.tenant?localStorage.setItem(l,JSON.stringify(e)):localStorage.removeItem(l)}function r(e){let{children:t}=e,[n,r]=(0,a.useState)(o);(0,a.useEffect)(()=>{r(function(){try{var e,t,n,i,a;let d=localStorage.getItem(l);if(!d)return o;let s=JSON.parse(d);if((null==s?void 0:s.token)&&(null==s||null==(e=s.tenant)?void 0:e.id))return{user:null!=(t=s.user)?t:null,tenant:null!=(n=s.tenant)?n:null,role:null!=(i=s.role)?i:"",outletId:null!=(a=s.outletId)?a:null,token:s.token}}catch(e){}return o}())},[]);let _=(0,a.useCallback)(e=>{r(e),u(e)},[]),c=(0,a.useCallback)(async(e,t)=>{var n;let i=await fetch("".concat(d,"/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!i.ok)throw Error((await i.json().catch(()=>({}))).error||"Login failed");let a=await i.json();_({user:a.user,tenant:a.tenant,role:a.role,outletId:null!=(n=a.outletId)?n:null,token:a.token})},[_]),p=(0,a.useCallback)(async(e,t,n)=>{let i=await fetch("".concat(d,"/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t,businessName:n})});if(!i.ok)throw Error((await i.json().catch(()=>({}))).error||"Registration failed");let a=await i.json();_({user:a.user,tenant:a.tenant,role:a.role,outletId:null,token:a.token})},[_]),v=(0,a.useCallback)(()=>{_(o)},[_]),f=(0,a.useCallback)(e=>{r(t=>{let n={...t,outletId:e};return u(n),n})},[]);return(0,i.jsx)(s.Provider,{value:{...n,login:c,register:p,logout:v,setOutletId:f,setAuth:_},children:t})}function _(){let e=(0,a.useContext)(s);if(!e)throw Error("useAuth must be used within AuthProvider");return e}function c(){try{var e;let t=localStorage.getItem(l);if(!t)return null;let n=JSON.parse(t);return null!=(e=null==n?void 0:n.token)?e:null}catch(e){return null}}},7138:(e,t,n)=>{n.d(t,{db:()=>d});var i=n(3278);class a extends i.Ay{constructor(){super("BluecountsDB"),this.version(1).stores({products:"id, tenant_id, outlet_id, [tenant_id+outlet_id], [tenant_id+sku], version_id",inventory:"id, tenant_id, outlet_id, product_id, [tenant_id+outlet_id+product_id], version_id",sales:"id, tenant_id, outlet_id, device_id, [tenant_id+device_id+device_transaction_id], version_id, created_at",sale_items:"id, sale_id, tenant_id, outlet_id, product_id",sync_queue:"id, timestamp, status",sync_meta:"key"}),this.version(2).stores({products:"id, tenant_id, outlet_id, [tenant_id+outlet_id], [tenant_id+sku], version_id",inventory:"id, tenant_id, outlet_id, product_id, [tenant_id+outlet_id+product_id], version_id",sales:"id, tenant_id, outlet_id, device_id, session_id, [tenant_id+device_id+device_transaction_id], version_id, created_at",sale_items:"id, sale_id, tenant_id, outlet_id, product_id",pos_sessions:"id, tenant_id, outlet_id, user_id, [outlet_id+status], version_id, opened_at",sync_queue:"id, timestamp, status",sync_meta:"key"}),this.version(3).stores({products:"id, tenant_id, [tenant_id+sku], version_id",inventory:"id, tenant_id, outlet_id, product_id, [tenant_id+outlet_id+product_id], version_id",sales:"id, tenant_id, outlet_id, device_id, session_id, [tenant_id+device_id+device_transaction_id], version_id, created_at",sale_items:"id, sale_id, tenant_id, outlet_id, product_id",pos_sessions:"id, tenant_id, outlet_id, user_id, [outlet_id+status], version_id, opened_at",sync_queue:"id, timestamp, status",sync_meta:"key"})}}let d=new a},9058:(e,t,n)=>{n.d(t,{a:()=>c});var i=n(2115),a=n(7138),d=n(5380),l=n(5704);let o="local_max_version_id",s="bluecounts_simulate_offline",u=l.env.NEXT_PUBLIC_API_URL||"http://localhost:3001";function r(){return"1"===localStorage.getItem(s)}function _(){let e=(0,d.c)(),t={"Content-Type":"application/json"};return e&&(t.Authorization="Bearer ".concat(e)),t}function c(e){let{tenantId:t,outletId:n,deviceId:d,enabled:l=!0}=e,[c,p]=(0,i.useState)(()=>r()),[v,f]=(0,i.useState)(window.navigator.onLine),y=v&&!c,w=(0,i.useCallback)(e=>{e?localStorage.setItem(s,"1"):localStorage.removeItem(s),p(e)},[]),[b,h]=(0,i.useState)("idle"),[m,g]=(0,i.useState)(null),[k,q]=(0,i.useState)(0),S=(0,i.useCallback)(async()=>{let e=await a.db.sync_meta.get(o),t=null==e?void 0:e.value;return"number"==typeof t?t:"string"==typeof t&&parseInt(t,10)||0},[]),C=(0,i.useCallback)(async e=>{await a.db.sync_meta.put({key:o,value:e})},[]),I=(0,i.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(t){h("pulling"),g(null);try{var n,i,d,l,o,s,r,c,p,v,f,y,w,b;let h=await S();if(e)h=0;else{let e=await a.db.products.where("tenant_id").equals(t).count();0===e&&(h=0)}let m="".concat(u,"/sync/pull?tenant_id=").concat(encodeURIComponent(t),"&max_version_id=").concat(h),g=await fetch(m,{headers:_()});if(!g.ok)throw Error("Pull failed: ".concat(g.status));let{tables:k,server_max_version_id:q}=await g.json();if(null==(n=k.products)?void 0:n.length)for(let e of k.products)e.deleted_at?await a.db.products.update(e.id,{deleted_at:e.deleted_at,version_id:e.version_id}):await a.db.products.put({id:e.id,tenant_id:e.tenant_id,sku:e.sku,name:e.name,description:null!=(s=e.description)?s:null,price:Number(e.price),version_id:e.version_id,created_at:e.created_at,updated_at:e.updated_at,deleted_at:null!=(r=e.deleted_at)?r:null});if(null==(i=k.inventory)?void 0:i.length)for(let e of k.inventory){let t=[e.tenant_id,e.outlet_id,e.product_id];for(let n of(await a.db.inventory.where("[tenant_id+outlet_id+product_id]").equals(t).toArray()))n.id!==e.id&&await a.db.inventory.delete(n.id);e.deleted_at?await a.db.inventory.update(e.id,{deleted_at:e.deleted_at,version_id:e.version_id}):await a.db.inventory.put({id:e.id,tenant_id:e.tenant_id,outlet_id:e.outlet_id,product_id:e.product_id,quantity:Number(e.quantity),version_id:e.version_id,created_at:e.created_at,updated_at:e.updated_at,deleted_at:null!=(c=e.deleted_at)?c:null})}if(null==(d=k.sales)?void 0:d.length)for(let e of k.sales)e.deleted_at?await a.db.sales.update(e.id,{deleted_at:e.deleted_at,version_id:e.version_id}):await a.db.sales.put({id:e.id,tenant_id:e.tenant_id,outlet_id:e.outlet_id,device_id:e.device_id,session_id:null!=(p=e.session_id)?p:null,device_transaction_id:e.device_transaction_id,total_amount:Number(e.total_amount),version_id:e.version_id,created_at:e.created_at,updated_at:e.updated_at,deleted_at:null!=(v=e.deleted_at)?v:null});if(null==(l=k.sale_items)?void 0:l.length)for(let e of k.sale_items)e.deleted_at?await a.db.sale_items.update(e.id,{deleted_at:e.deleted_at,version_id:e.version_id}):await a.db.sale_items.put({id:e.id,tenant_id:e.tenant_id,outlet_id:e.outlet_id,sale_id:e.sale_id,product_id:e.product_id,quantity:e.quantity,unit_price:Number(e.unit_price),line_total:Number(e.line_total),version_id:e.version_id,created_at:e.created_at,deleted_at:null!=(f=e.deleted_at)?f:null});if(null==(o=k.pos_sessions)?void 0:o.length)for(let e of k.pos_sessions)e.deleted_at?await a.db.pos_sessions.update(e.id,{deleted_at:e.deleted_at,version_id:e.version_id}):await a.db.pos_sessions.put({id:e.id,tenant_id:e.tenant_id,outlet_id:e.outlet_id,user_id:e.user_id,device_id:null!=(y=e.device_id)?y:null,opening_balance:Number(e.opening_balance),closing_balance:null!=e.closing_balance?Number(e.closing_balance):null,expected_balance:null!=e.expected_balance?Number(e.expected_balance):null,status:"closed"===e.status?"closed":"open",opened_at:e.opened_at,closed_at:null!=(w=e.closed_at)?w:null,version_id:e.version_id,deleted_at:null!=(b=e.deleted_at)?b:null});"number"==typeof q&&await C(q)}catch(e){g(e instanceof Error?e.message:"Pull failed"),h("error");return}h("idle")}},[t,n,S,C]),E=(0,i.useCallback)(async()=>{if(!t||!n||!d)return;let e=await a.db.sync_queue.where("status").equals("pending").toArray();if(0===e.length)return void q(0);h("pushing"),g(null);try{let i=e.map(e=>({id:e.id,action_type:e.action_type,payload:e.payload})),l=await fetch("".concat(u,"/sync"),{method:"POST",headers:_(),body:JSON.stringify({tenant_id:t,outlet_id:n,device_id:d,items:i})});if(!l.ok){let e=await l.text();throw Error(e||"Push failed: ".concat(l.status))}let o=await l.json();for(let e of(null!=o.version_id&&await C(o.version_id),o.results||[]))"accepted"===e.status||"synced"===e.status?await a.db.sync_queue.update(e.queue_id,{status:"synced"}):"failed"===e.status&&await a.db.sync_queue.update(e.queue_id,{status:"failed",error_message:e.error});let s=await a.db.sync_queue.where("status").equals("pending").count();q(s)}catch(e){g(e instanceof Error?e.message:"Push failed"),h("error");return}h("idle"),q(await a.db.sync_queue.where("status").equals("pending").count())},[t,n,d,C]),N=(0,i.useCallback)(async()=>{l&&(await I(!0),await E(),await I(!0))},[l,I,E]);return(0,i.useEffect)(()=>{l&&t&&y&&I(!0)},[t,l,y]),(0,i.useEffect)(()=>{let e=()=>{f(!0),!r()&&l&&t&&N()},n=()=>f(!1);return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}},[l,t,N]),(0,i.useEffect)(()=>{let e=!1;a.db.sync_queue.where("status").equals("pending").count().then(t=>{e||q(t)});let t=setInterval(()=>{a.db.sync_queue.where("status").equals("pending").count().then(t=>{e||q(t)})},2e3);return()=>{e=!0,clearInterval(t)}},[]),{isOnline:y,syncState:b,lastError:m,pendingCount:k,sync:N,pull:I,push:E,simulateOffline:c,setSimulateOffline:w}}}}]);